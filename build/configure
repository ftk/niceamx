#!/bin/bash
flags=""

wd=`dirname $0`

if [ -z "$OUT" ]
then
  OUT="Makefile"
fi

if [ -z "$BUILDER" ]
then
  BUILDER="$wd/build.sh"
fi

for i in $LDFLAGS
do
  flags="$flags --lparam $i"
done
for i in $CXXFLAGS $CPPFLAGS
do
  flags="$flags --param $i"
done

flags="$flags $@"

CONFIG="build.txt"
while [ ! -z "$2" ]
do
  if [ "$1" = "--config" ]
  then
    CONFIG="$2"
    shift 1
  fi
  shift 1
done


TARGET="`$BUILDER $flags --getconf project`"
echo "project: $TARGET"
$wd/build.sh $flags --makefile > $OUT
if [ $? -ne 0 ]
then
  echo "aborted"
  exit 1
fi
echo "# generated by $0 for $TARGET" >> $OUT
echo '.PHONY: install depend' >> $OUT
echo -e "install: ../server/plugins/${TARGET}\n../server/plugins/${TARGET}: $TARGET\n\tcp -vf $TARGET" '$@' >> $OUT
#echo -e "depend:\n\t$BUILDER $flags $@ --makefile > $OUT" >> $OUT
echo -e "depend: $OUT\n$OUT: $CONFIG $BUILDER\n\tenv OUT=\"$OUT\" $0 $flags" >> $OUT
echo "now run: make -f $OUT"
